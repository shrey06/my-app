currentBuild.displayName = "MyAppBuild#" + currentBuild.number
pipeline{
  agent any
  stages{
      stage("Code Checkout"){
        steps{
          git branch: 'devops', url: 'https://github.com/gauravjadhav8/my-app'
        }
      }
      stage("Compile-Package"){
        steps{
              sh "mvn clean package"
          }
      }
      stage("Sonar Analysis"){
        steps{
              withSonarQubeEnv('sonar-jenkins-poc') { 
                sh "mvn sonar:sonar"
              }
          }
      }
      stage ("Sonar QualityGate") {
       steps {
        script {
            def qualitygate = waitForQualityGate()
            if (qualitygate.status != "OK") {
              slackSend baseUrl: 'https://hooks.slack.com/services/',
              channel: '#jenkins-poc',
              color: 'danger',
              message: "Sonar Quality gate failed with status: ${qualitygate.status}",
              teamDomain: 'kuliza-talk',
              tokenCredentialId: 'jenkins-poc-slack-token'
              error "Pipeline aborted due to quality gate coverage failure: ${qualitygate.status}"
            }
          }
        }
      }
      stage("Email Notification"){
        steps{
           mail bcc: '', body: '''Hi Team,
Jenkins Build has run successfully.

Thanks,
Lendin Jenkins''',
           cc: '',
           from: '',
           replyTo: '',
           subject: 'Jenkins Pipeline POC',
           to: 'shrey.bhasin@kuliza.com,gaurav.jadhav@kuliza.com,manjunath.c@kuliza.com'
        }
      }
      
      stage("Slack Notification"){
        steps{  
            slackSend baseUrl: 'https://hooks.slack.com/services/',
            channel: '#jenkins-poc',
            color: 'good',
            message: 'Jenkins build ran successfully.',
            teamDomain: 'kuliza-talk',
            tokenCredentialId: 'jenkins-poc-slack-token'
          }
      }
   }
}
